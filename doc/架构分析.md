# NbDNS 项目架构分析与调用关系梳理

### 一、项目概述

**NbDNS** 是一个智能 DNS 中继器（DNS Relay/Forwarder），具备以下核心功能：
- 多上游 DNS 服务器支持（UDP/TCP/TLS/DoH）
- 智能分流策略（国内/国外 DNS 分流）
- 内建缓存系统（BadgerDB）
- Web 监控面板
- DoH（DNS over HTTPS）服务端支持
- 统计分析与持久化

---

### 二、项目架构分层

```
┌─────────────────────────────────────────────────────────────┐
│                      应用层 (main.go)                        │
│  - 启动管理  - 配置加载  - 优雅关闭  - 自动更新             │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                     服务层 (3大服务)                         │
├──────────────┬──────────────────┬───────────────────────────┤
│  DNS服务     │  Web服务         │  DoH服务                  │
│  (UDP/TCP)   │  (监控面板)      │  (HTTPS DNS)              │
└──────────────┴──────────────────┴───────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    核心逻辑层 (internal/)                    │
├──────────────┬──────────────────┬───────────────────────────┤
│  handler/    │  cache/          │  stats/                   │
│  DNS处理器   │  缓存系统        │  统计模块                 │
├──────────────┼──────────────────┼───────────────────────────┤
│  model/      │  web/            │                           │
│  数据模型    │  Web处理器       │                           │
└──────────────┴──────────────────┴───────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  基础设施层 (pkg/)                           │
├──────────────┬──────────────────┬───────────────────────────┤
│  doh/        │  logger/         │  utils/                   │
│  DoH客户端   │  日志系统        │  工具函数                 │
└──────────────┴──────────────────┴───────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│               第三方依赖 (外部服务与库)                      │
│  - miekg/dns (DNS协议)    - BadgerDB (缓存)                 │
│  - cidranger (IP段匹配)   - godropbox (连接池)              │
└─────────────────────────────────────────────────────────────┘
```

---

### 三、核心模块详解

#### 3.1 主程序 (main.go)

**职责**：应用启动、服务编排、生命周期管理

**关键流程**：
```
1. 数据路径检测 (detectDataPath)
   ↓
2. 加载中国IP段 (loadIPRanger)
   ↓
3. 读取配置文件 (config.ReadInConfig)
   ↓
4. 初始化组件：
   - Logger (调试日志)
   - Stats (统计记录器)
   - Cache (BadgerDB缓存)
   - Handler (DNS处理器)
   ↓
5. 启动Bootstrap连接池
   ↓
6. 初始化Upstream连接池
   ↓
7. 启动3大服务：
   - DNS服务器 (UDP + TCP)
   - Web服务器 (监控面板 + DoH + pprof)
   - 后台任务 (统计保存、更新检查)
   ↓
8. 优雅关闭 (保存统计、关闭缓存)
```

---

#### 3.2 配置模型 config.go & upstream.go)

**Config 结构**：
- `ServeAddr`: DNS监听地址 (如 127.0.0.1:8853)
- `WebAddr`: Web面板地址 (如 0.0.0.0:8854)
- `Strategy`: 查询策略 (1=最全/2=最快/3=任一)
- `BuiltInCache`: 是否启用缓存
- `Bootstrap`: 引导DNS列表 (仅支持IP)
- `Upstreams`: 上游DNS列表
- `Blacklist`: 域名黑名单
- `DohServer`: DoH服务配置

**Upstream 结构**：
- `IsPrimary`: 是否为国内DNS
- `UseSocks`: 是否使用SOCKS5代理
- `Address`: 上游地址 (格式: protocol://host:port)
- `Match`: 匹配规则 (仅对特定域名生效)
- `pool`: 连接池 (TCP/TLS复用)
- `dohClient`: DoH客户端实例

**支持的协议**：
- `udp://` - UDP明文
- `tcp://` - TCP明文
- `tcp-tls://` - TCP over TLS
- `https://` - DoH (DNS over HTTPS)

---

#### 3.3 DNS处理器 (internal/handler/handler.go)

**核心组件 Handler**：

```go
type Handler struct {
    strategy                          int              // 查询策略
    commonUpstreams, specialUpstreams []*model.Upstream // 普通/特殊上游
    builtInCache                      cache.Cache      // 缓存实例
    logger                            logger.Logger    // 日志记录
    stats                             stats.StatsRecorder // 统计记录
}
```

**主要方法调用链**：

1. **HandleRequest (DNS服务入口)**
   ```
   提取客户端IP → HandleDnsMsg → WriteMsg响应
   ```

2. **HandleDnsMsg (核心处理逻辑)**
   ```
   记录统计
     ↓
   检查缓存 → 命中返回
     ↓ (未命中)
   调用 exchange
     ↓
   验证响应 (防投毒)
     ↓
   写入缓存
     ↓
   返回响应
   ```

3. **exchange (上游查询)**
   ```
   清理EDNS客户端子网
     ↓
   选择策略：
   - StrategyFullest: getTheFullestResults (最全)
   - StrategyFastest: getTheFastestResults (最快)
   - StrategyAnyResult: getAnyResult (任一)
     ↓
   去重合并
   ```

**查询策略详解**：

| 策略         | 行为                                     | 适用场景           |
| ------------ | ---------------------------------------- | ------------------ |
| **最全结果** | 并发查询所有上游，等待全部返回，合并结果 | Bootstrap模式      |
| **最快结果** | 并发查询，国内外DNS都返回时退出          | 主查询模式（推荐） |
| **任一结果** | 并发查询，任一上游返回即退出             | 快速响应           |

**智能分流逻辑**：
```go
IsValidMsg() {
    域名在黑名单 && IP是国内 → 无效
    上游是Primary && IP非国内 → 无效
    Primary上游必须有Answer → 有效
}
```

---

#### 3.4 缓存系统 (internal/cache/badger_cache.go)

**BadgerCache 实现**：

```go
type BadgerCache struct {
    db     *badger.DB      // BadgerDB实例
    logger logger.Logger   // 日志
}

type CachedMsg struct {
    Msg     *dns.Msg      // DNS消息
    Expires time.Time     // 过期时间
}
```

**缓存策略**：
- **容量限制**：40MB总大小（32MB块缓存 + 8MB内存表）
- **TTL范围**：最小60秒，最大3600秒
- **GC机制**：每5分钟运行一次
- **持久化**：磁盘存储，重启后保留

**缓存键格式**：
```
域名#查询类型#DNSSEC标志
例如: google.com.#1#DO
```

**防缓存投毒验证**：
1. 域名匹配检查
2. 查询类型匹配
3. 查询类别匹配
4. Answer记录域名验证
5. TTL合理性检查

---

#### 3.5 统计系统 (internal/stats/stats.go)

**Stats 核心数据**：

```go
type Stats struct {
    StartTime      time.Time          // 应用启动时间
    StatsStartTime time.Time          // 统计开始时间
    TotalQueries   atomic.Uint64      // 总查询数
    DoHQueries     atomic.Uint64      // DoH查询数
    CacheHits      atomic.Uint64      // 缓存命中
    CacheMisses    atomic.Uint64      // 缓存未命中
    FailedQueries  atomic.Uint64      // 失败查询
    upstreamStats  map[string]*UpstreamStats // 上游统计
    topClients     *TopNTracker       // Top客户端
    topDomains     *TopNTracker       // Top域名
}
```

**TopNTracker 设计**：
- 使用内存可控的Top-N算法
- 自动淘汰低频项目
- 记录客户端与域名关联

**持久化**：
- 每小时自动保存到 stats.json
- 应用关闭时保存
- 启动时恢复历史数据

---

#### 3.6 Web服务 (internal/web/handler.go)

**路由表**：

| 路径                | 方法 | 功能         |
| ------------------- | ---- | ------------ |
| `/`                 | GET  | 静态首页     |
| `/api/stats`        | GET  | 获取统计快照 |
| `/api/stats/reset`  | POST | 重置统计数据 |
| `/api/version`      | GET  | 查询版本     |
| `/api/check-update` | GET  | 触发更新检查 |

**静态资源**：
- 使用 `embed.FS` 嵌入前端文件
- 包含 `index.html`、`app.js`、`style.css`

---

#### 3.7 DoH服务 server.go & client.go)

**DoH Server**：
- 支持 Basic Auth 认证
- 接收 GET 请求（Base64编码的DNS消息）
- 提取客户端真实IP（X-Forwarded-For → X-Real-IP → RemoteAddr）
- 复用 Handler 的 DNS 处理逻辑

**DoH Client**：
- 支持 HTTP/HTTPS
- 支持 SOCKS5 代理
- 支持自定义 Bootstrap 解析
- 连接复用（HTTP Keep-Alive）

---

### 四、完整调用关系图

```
用户DNS查询 (dig @127.0.0.1 -p 8853 google.com)
    ↓
┌─────────────────────────────────────────┐
│  DNS Server (UDP/TCP)                   │
│  - dns.HandleFunc(".", handler)         │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  Handler.HandleRequest                  │
│  1. extractClientIPFromDNS()            │
│  2. 提取域名                             │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  Handler.HandleDnsMsg                   │
│  1. stats.RecordQuery()                 │
│  2. stats.RecordClientQuery()           │
└─────────────────────────────────────────┘
    ↓
    缓存检查
    ↓
┌─────────────────────────────────────────┐
│  cache.Get(key)                         │
│  - 命中 → stats.RecordCacheHit()        │
│  - 未命中 → stats.RecordCacheMiss()     │
└─────────────────────────────────────────┘
    ↓ (缓存未命中)
┌─────────────────────────────────────────┐
│  Handler.exchange(req)                  │
│  1. removeEDNS() 清理客户端子网          │
│  2. 根据策略调用：                       │
│     - getTheFullestResults()            │
│     - getTheFastestResults()            │
│     - getAnyResult()                    │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  matchedUpstreams(req)                  │
│  1. 检查域名是否匹配特殊规则             │
│  2. 返回 commonUpstreams 或              │
│     specialUpstreams                    │
└─────────────────────────────────────────┘
    ↓
    并发查询各上游
    ↓
┌─────────────────────────────────────────┐
│  Upstream.Exchange(req)                 │
│  根据协议选择：                          │
│  - UDP: dns.Client.Exchange()           │
│  - TCP/TLS: pool.Get() + dnsExchange    │
│  - HTTPS: dohClient.Exchange()          │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  stats.RecordUpstreamQuery()            │
│  记录上游查询和错误                      │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  Upstream.IsValidMsg(msg)               │
│  验证IP归属和黑名单                      │
└─────────────────────────────────────────┘
    ↓
    合并结果
    ↓
┌─────────────────────────────────────────┐
│  validateResponse(req, resp)            │
│  防缓存投毒验证                          │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│  cache.Set(key, msg, ttl)               │
│  写入BadgerDB缓存                        │
└─────────────────────────────────────────┘
    ↓
    返回响应
```

---

### 五、关键数据流

#### 5.1 配置加载流程

```
main()
  ↓
detectDataPath() → 找到data目录
  ↓
loadIPRanger() → 加载china_ip_list.txt
  ↓
config.ReadInConfig()
  ├─ json.Unmarshal → 解析配置
  ├─ Bootstrap初始化
  │   ├─ upstream.Init()
  │   └─ upstream.InitConnectionPool(nil)
  └─ Upstreams初始化
      ├─ upstream.Init()
      └─ upstream.Validate()
  ↓
bootstrapHandler创建 (不带缓存)
  ↓
Upstreams初始化连接池
  upstream.InitConnectionPool(bootstrapHandler.LookupIP)
  ↓
upstreamHandler创建 (带缓存)
```

#### 5.2 DNS查询流程 (最快结果策略)

```
getTheFastestResults()
  ↓
并发启动所有上游查询
  ├─ Primary DNS (国内)
  └─ Freedom DNS (国外)
  ↓
  等待条件满足：
  ├─ 所有上游完成 → 返回结果
  ├─ Primary有结果 && Freedom有结果 → 立即返回
  └─ Primary返回国内IP → 立即返回
  ↓
  结果验证：
  ├─ IsValidMsg() → 检查IP归属
  └─ 区分 primaryIndex / freedomIndex
  ↓
返回有效响应
```

#### 5.3 连接池管理

```
Upstream.InitConnectionPool()
  ↓
根据协议类型：
  ├─ UDP → 不需要连接池
  ├─ TCP/TLS → net2.NewSimpleConnectionPool
  │   ├─ MaxActive: 10
  │   ├─ MaxIdle: 5
  │   ├─ MaxIdleTime: timeout*10
  │   └─ Dial: conntionFactory()
  └─ HTTPS → doh.NewClient
      ├─ 支持Bootstrap解析
      ├─ 支持SOCKS5代理
      └─ HTTP连接复用
```

---

### 六、技术亮点

1. **智能分流算法**
   - 基于IP段匹配的国内外DNS分流
   - 黑名单域名强制使用海外DNS
   - 防止DNS污染

2. **高性能设计**
   - 连接池复用（TCP/TLS）
   - 并发查询策略
   - BadgerDB缓存（LSM Tree）

3. **可观测性**
   - 详细的统计信息（QPS、命中率、延迟）
   - Top-N 客户端和域名追踪
   - 统计数据持久化

4. **安全性**
   - 缓存投毒防护（多维度验证）
   - EDNS客户端子网清理
   - DoH Basic Auth 认证

5. **可维护性**
   - 清晰的分层架构
   - 接口抽象（Cache、Logger、StatsRecorder）
   - 配置文件热加载支持

---

### 七、部署架构

```
┌─────────────────────────────────────────┐
│          客户端设备                      │
│  - 系统DNS: 127.0.0.1:8853              │
│  - 浏览器DoH: http://localhost:8854     │
└─────────────────────────────────────────┘
              ↓ DNS查询
┌─────────────────────────────────────────┐
│          NbDNS服务                       │
│  ┌─────────────┬─────────────┐          │
│  │ DNS服务     │ Web监控     │          │
│  │ :8853       │ :8854       │          │
│  └─────────────┴─────────────┘          │
│  ┌─────────────────────────────┐        │
│  │ BadgerDB缓存                 │        │
│  │ data/cache/                  │        │
│  └─────────────────────────────┘        │
└─────────────────────────────────────────┘
              ↓ 上游查询
┌─────────────────────────────────────────┐
│          上游DNS服务器                   │
│  ┌────────────┬────────────────────┐    │
│  │ 国内DNS    │ 国外DNS             │    │
│  │ 223.5.5.5  │ 1.1.1.1 (via SOCKS)│    │
│  │ 223.6.6.6  │ dns.google (DoH)   │    │
│  └────────────┴────────────────────┘    │
└─────────────────────────────────────────┘
```

---

### 八、目录结构总结

```
nbdns4HB/
├── main.go                    # 主程序入口
├── go.mod                     # Go模块依赖
├── Dockerfile                 # Docker镜像构建
├── README.md                  # 项目文档
├── data/                      # 数据目录
│   ├── config.json            # 配置文件
│   ├── china_ip_list.txt      # 中国IP段数据
│   └── cache/                 # 缓存和统计数据
│       └── stats.json         # 统计数据持久化
├── internal/                  # 内部核心逻辑
│   ├── handler/               # DNS请求处理器
│   │   └── handler.go         # 查询策略、上游调度
│   ├── model/                 # 数据模型
│   │   ├── config.go          # 配置结构
│   │   └── upstream.go        # 上游DNS模型
│   ├── cache/                 # 缓存系统
│   │   └── badger_cache.go    # BadgerDB实现
│   ├── stats/                 # 统计系统
│   │   └── stats.go           # 查询统计、Top-N
│   └── web/                   # Web服务
│       ├── handler.go         # API路由处理
│       └── static/            # 前端静态文件
│           ├── index.html
│           ├── app.js
│           └── style.css
└── pkg/                       # 可复用基础组件
    ├── doh/                   # DNS over HTTPS
    │   ├── client.go          # DoH客户端
    │   └── server.go          # DoH服务端
    ├── logger/                # 日志系统
    │   └── logger.go
    ├── utils/                 # 工具函数
    │   └── utils.go           # 域名匹配规则
    └── qqwry/                 # IP地理位置库
        └── qqwry.go
```

---

### 九、建议改进点

1. **性能优化**
   - 引入Prometheus指标导出
   - 增加请求限流机制
   - 优化连接池参数

2. **功能增强**
   - 支持DNS-over-QUIC (DoQ)
   - 支持IPv6解析
   - 增加DNS黑洞功能（广告过滤）

3. **监控告警**
   - 上游健康检查
   - 自动故障切换
   - 告警通知

4. **配置管理**
   - 支持热重载配置
   - 配置文件验证
   - 多环境配置

这个项目是一个设计良好的Go应用，展示了清晰的分层架构、并发处理、缓存策略和可观测性实践。---

### 九、建议改进点

1. **性能优化**
   - 引入Prometheus指标导出
   - 增加请求限流机制
   - 优化连接池参数

2. **功能增强**
   - 支持DNS-over-QUIC (DoQ)
   - 支持IPv6解析
   - 增加DNS黑洞功能（广告过滤）

3. **监控告警**
   - 上游健康检查
   - 自动故障切换
   - 告警通知

4. **配置管理**
   - 支持热重载配置
   - 配置文件验证
   - 多环境配置
